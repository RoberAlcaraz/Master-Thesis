---
title: '**TFM**'
author: '*Roberto Jesús Alcaraz Molina*'
date: "11/02/2021"
output:
  pdf_document:
    toc: T
    fig_caption: yes
header-includes: 
- \usepackage{float}
- \usepackage{amsbsy}
- \usepackage{amsmath}
- \usepackage{graphicx}
- \usepackage{subfig}
- \usepackage{booktabs}
---

```{r include=FALSE}
knitr::opts_chunk$set(warning = FALSE, 
                      echo = F, 
                      message = FALSE,
                      fig.pos="H", 
                      fig.align="center",
                      fig.width=15,
                      cache=FALSE, error = TRUE)
```

```{r, echo = F}
# install.packages("pacman")
pacman::p_load(tidyverse, tidymodels, workflows, tune, dotwhisker)

# Models packages
pacman::p_load(ranger)
```

```{r}
# df <- read.table("BBDD_DEFINITIVA_V4.txt", header = T)
# saveRDS(df, "BBDD_DEFINITIVA_V4.RDS")

df <- readRDS("BBDD_DEFINITIVA_V4.RDS")
```

- CLAVE: Identification of the person
- PERIODO: Period (year)
- COVER: Number of coverages (1, 2 or 3)
- SEXO: 
- FUMADOR:       
- BUENA_SALUD: Yes or No  
- EDAD_ACTUARIAL: actuarial age in each year
- EDAD_SUS: actuarial age in the moment of suscription  
- EXP: Tiempo de exposición de la póliza al riesgo de fallecimiento durante el año.
- SINIESTRO: Yes or No

- DURACION: Number of years in force of the policy
- DURACION_CAT: Rounded duration

- CAPITAL: Capital asegurado. Dinero que recibirá el beneficiario en caso de siniestro

- CAPITAL_CAT1: 
- CAPITAL_CAT2:      
- CAPITAL_CAT3: 
- CAPITAL_CAT1_DESC: 
- CAPITAL_CAT2_DESC:
- CAPITAL_CAT3_DESC:

- IMC:          
- IMC_CAT1:    
- IMC_CAT2:          
- IMC_CAT3:
- IMC_CAT1_DESC:    
- IMC_CAT2_DESC:  

```{r}
df$PERIODO           <- factor(df$PERIODO)
df$COVER             <- factor(df$COVER)
df$SEXO              <- factor(ifelse(df$SEXO == 0, "hombre", "mujer"))
df$FUMADOR           <- factor(ifelse(df$FUMADOR == 0, "noFumador", "Fumador"))
df$BUENA_SALUD       <- factor(ifelse(df$BUENA_SALUD == 1, "si", "no"))
df$EXP               <- as.numeric(gsub(",", ".", gsub("\\.", "", df$EXP)))
df$SINIESTRO         <- factor(ifelse(df$SINIESTRO == 1, "si", "no"))
df$DURACION          <- as.numeric(gsub(",", ".", gsub("\\.", "", df$DURACION)))

df$CAPITAL_CAT1_DESC <- factor(df$CAPITAL_CAT1_DESC, 
                               levels = c("0-30.000", "30.001-60.000", "60.001-90.000",
                                          "90.001-120.000", "120.001-150.000", "+150.000"),
                               ordered = T)
df$CAPITAL_CAT2_DESC <- factor(df$CAPITAL_CAT2_DESC, 
                               levels = c("0-60.000", "60.001-120.000", "+120.000"),
                               ordered = T)

df$CAPITAL_CAT3_DESC <- factor(df$CAPITAL_CAT3_DESC, 
                               levels = c("0-100.000", "100.001-200.000", "+200.000"),
                               ordered = T)

df$IMC               <- as.numeric(gsub(",", ".", gsub("\\.", "", df$IMC)))
df$IMC_CAT1_DESC     <- factor(df$IMC_CAT1_DESC)
df$IMC_CAT2_DESC     <- factor(df$IMC_CAT2_DESC)
```

Here, we remove the repeated columns
```{r}
df <- tibble::rowid_to_column(df, "ID")

# here we take the IDs that are not repeated
IDs <- df %>%
  arrange(desc(SINIESTRO)) %>%
  distinct_at(vars(CLAVE, PERIODO, COVER), .keep_all = T) %>%
  select(ID)

# here we ensure that the rows we are removing have SINIESTRO = 0
df %>%
  filter(!(ID %in% IDs$ID)) %>%
  select(SINIESTRO) %>%
  summary()

df <- df %>%
  filter(ID %in% IDs$ID)
```

Also, we create another df of only the people that had some sinister
```{r}
# SINIESTROS
clave_sin <- df %>% # tomamos todas las claves de las personas con siniestro
  filter(SINIESTRO == "si") %>%
  select(CLAVE)

df_sin <- df %>%
  filter(CLAVE %in% clave_sin$CLAVE)
```

And another one with the people that drop
```{r}
# CAIDAS
# Here we take the keys of the caidas
claves_caidas <- df %>%
  filter((CLAVE %in% clave_sin$CLAVE) == F) %>%
  group_by(CLAVE) %>%
  count() %>%
  mutate(CAIDA = ifelse(n == 1 | n == 2, "si", "no")) %>%
  filter(CAIDA == "si") %>%
  select(CLAVE)

df_caidas <- df %>%
  filter((CLAVE %in% clave_sin$CLAVE) == F) %>%
  mutate(CAIDA = ifelse(CLAVE %in% claves_caidas$CLAVE, "si", "no")) %>%
  arrange(CLAVE) 

for (i in 2:nrow(df_caidas)){
  if (df_caidas$CAIDA[i-1] == "si") {
    if (df_caidas$CLAVE[i-1] == df_caidas$CLAVE[i]) {
      df_caidas$CAIDA[i-1] = "no"
    }
  }
}

# saveRDS(df_caidas, file = "df_caidas.RDS")
```

```{r}
df_caidas <- readRDS("df_caidas.RDS")
```

# Description of the variables

- CLAVE: Identification of the person
- PERIODO: Period (year)
- COVER: Number of coverages (1, 2 or 3)
- SEXO: 
- FUMADOR:       
- BUENA_SALUD: Yes or No  
- EDAD_ACTUARIAL: actuarial age in each year
- EDAD_SUS: actuarial age in the moment of suscription  
- EXP: Tiempo de exposición de la póliza al riesgo de fallecimiento durante el año.
- SINIESTRO: Yes or No

- DURACION: Number of years in force of the policy
- DURACION_CAT: Rounded duration

- CAPITAL:
- CAPITAL_CAT1: 
- CAPITAL_CAT2:      
- CAPITAL_CAT3: 
- CAPITAL_CAT1_DESC: 
- CAPITAL_CAT2_DESC:
- CAPITAL_CAT3_DESC:

- IMC:          
- IMC_CAT1:    
- IMC_CAT2:          
- IMC_CAT3:
- IMC_CAT1_DESC:    
- IMC_CAT2_DESC:  

```{r}
# COVER
table(df$COVER)/nrow(df)
df %>%
  ggplot(aes(x = COVER)) +
  geom_bar() + theme_bw()
```

```{r}
# SEXO
table(df$SEXO)/nrow(df)
df %>%
  ggplot(aes(x = SEXO)) +
  geom_bar() + theme_bw()
```

```{r}
# FUMADOR
table(df$FUMADOR)/nrow(df)
df %>%
  ggplot(aes(x = FUMADOR)) +
  geom_bar() + theme_bw()
```

```{r}
# BUENA_SALUD  
table(df$BUENA_SALUD)/nrow(df)
df %>%
  ggplot(aes(x = BUENA_SALUD)) +
  geom_bar() + theme_bw()
```

```{r}
# EDAD_ACTUARIAL
df %>%
  ggplot(aes(x = EDAD_ACTUARIAL)) +
  geom_histogram() + theme_bw()
df %>%
  ggplot(aes(x = EDAD_ACTUARIAL)) +
  geom_density() + theme_bw()

# EDAD_SUS
df %>%
  ggplot(aes(x = EDAD_SUS)) +
  geom_histogram() + theme_bw()
df %>%
  ggplot(aes(x = EDAD_SUS)) +
  geom_density() + theme_bw()
```

```{r}
# EXP
table(ifelse(df$EXP == 1, "=1", "<1"))/nrow(df)
df %>%
  ggplot(aes(x = EXP)) +
  geom_histogram() + theme_bw()
df %>%
  ggplot(aes(x = EXP)) +
  geom_density() + theme_bw()
```


```{r}
# SINIESTRO
table(df$SINIESTRO)/nrow(df)
df %>%
  ggplot(aes(x = SINIESTRO)) +
  geom_bar() + theme_bw()
```

```{r}
# DURACION
df %>%
  ggplot(aes(x = DURACION)) +
  geom_histogram() + theme_bw()
df %>%
  ggplot(aes(x = DURACION)) +
  geom_density() + theme_bw()

# DURACION_CAT
df %>%
  ggplot(aes(x = DURACION_CAT)) +
  geom_histogram() + theme_bw()
df %>%
  ggplot(aes(x = DURACION_CAT)) +
  geom_density() + theme_bw()
```

```{r}
# CAPITAL
summary(df$CAPITAL)
df %>%
  ggplot(aes(x = CAPITAL)) +
  geom_histogram() + theme_bw()
df %>%
  ggplot(aes(x = CAPITAL)) +
  geom_density() + theme_bw()

# CAPITAL_DESC
table(df$CAPITAL_CAT1_DESC)/nrow(df)
df %>%
  ggplot(aes(x = CAPITAL_CAT1_DESC)) +
  geom_bar() + theme_bw()

table(df$CAPITAL_CAT2_DESC)/nrow(df)
df %>%
  ggplot(aes(x = CAPITAL_CAT2_DESC)) +
  geom_bar() + theme_bw()

table(df$CAPITAL_CAT3_DESC)/nrow(df)
df %>%
  ggplot(aes(x = CAPITAL_CAT3_DESC)) +
  geom_bar() + theme_bw()
```

```{r}
# IMC
summary(df$IMC)

# Persona de 1.80 y 180kg: 55.6 de IMC
df %>%
  filter(IMC > 55)

df %>%
  ggplot(aes(x = IMC)) +
  geom_histogram() + theme_bw()
df %>%
  ggplot(aes(x = IMC)) +
  geom_density() + theme_bw()

# IMC_DESC
table(df$IMC_CAT1_DESC)/nrow(df)
df %>%
  ggplot(aes(x = IMC_CAT1_DESC)) +
  geom_bar() + theme_bw()

table(df$IMC_CAT2_DESC)/nrow(df)
df %>%
  ggplot(aes(x = IMC_CAT2_DESC)) +
  geom_bar() + theme_bw()
```

```{r}
# CAIDAS
table(df_caidas$CAIDA)/nrow(df_caidas)
df_caidas %>%
  ggplot(aes(x = CAIDA)) +
  geom_bar() + theme_bw()
```



# Modelos

- CLAVE: Identification of the person
- PERIODO: Period (year)
- COVER: Number of coverages (1, 2 or 3)
- SEXO: 
- FUMADOR:       
- BUENA_SALUD: Yes or No  
- EDAD_ACTUARIAL: actuarial age in each year
- EDAD_SUS: actuarial age in the moment of suscription  
- EXP: Tiempo de exposición de la póliza al riesgo de fallecimiento durante el año.
- SINIESTRO: Yes or No

- DURACION: Number of years in force of the policy
- DURACION_CAT: Rounded duration

- CAPITAL:
- CAPITAL_CAT1: 
- CAPITAL_CAT2:      
- CAPITAL_CAT3: 
- CAPITAL_CAT1_DESC: 
- CAPITAL_CAT2_DESC:
- CAPITAL_CAT3_DESC:

- IMC:          
- IMC_CAT1:    
- IMC_CAT2:          
- IMC_CAT3:
- IMC_CAT1_DESC:    
- IMC_CAT2_DESC: 

## Explanatory model

```{r}
set.seed(123)
df_split <- initial_split(data = df, prop = 3/4, strata = SINIESTRO)
df_train <- training(df_split)
df_test <- testing(df_split)
```

```{r}
my_formula_1 <- as.formula(SINIESTRO ~ PERIODO + COVER + SEXO + FUMADOR + BUENA_SALUD + EDAD_ACTUARIAL + EXP + DURACION + CAPITAL + IMC)
my_formula_2 <- as.formula(SINIESTRO ~ PERIODO + COVER + SEXO + FUMADOR + BUENA_SALUD + EDAD_ACTUARIAL + EXP + DURACION + CAPITAL + IMC_CAT1_DESC)
my_formula_3 <- as.formula(SINIESTRO ~ PERIODO + COVER + SEXO + FUMADOR + BUENA_SALUD + EDAD_ACTUARIAL + EXP + DURACION + CAPITAL + IMC_CAT2_DESC)
my_formula_4 <- as.formula(SINIESTRO ~ PERIODO + COVER + SEXO + FUMADOR + BUENA_SALUD + EDAD_ACTUARIAL + EXP + DURACION + IMC + CAPITAL_CAT1_DESC)
my_formula_5 <- as.formula(SINIESTRO ~ PERIODO + COVER + SEXO + FUMADOR + BUENA_SALUD + EDAD_ACTUARIAL + EXP + DURACION + IMC + CAPITAL_CAT2_DESC)
my_formula_6 <- as.formula(SINIESTRO ~ PERIODO + COVER + SEXO + FUMADOR + BUENA_SALUD + EDAD_ACTUARIAL + EXP + DURACION + IMC + CAPITAL_CAT3_DESC)
```


```{r}
glm_model <- logistic_reg() %>% 
  set_engine("glm") %>% 
  set_mode("classification")

glm_fit <- glm_model %>%
  fit(my_formula_1, data = df_train)

tidy(glm_fit) %>% 
  dwplot(dot_args = list(size = 2, color = "black"),
         whisker_args = list(color = "black"),
         vline = geom_vline(xintercept = 0, colour = "grey50", linetype = 2))

test_predictions <- predict(glm_fit, new_data = df_test)
test_predictions <- test_predictions %>%
  mutate(SINIESTRO = df_test$SINIESTRO)

test_predictions %>% 
  conf_mat(truth = SINIESTRO, estimate = .pred_class) %>%
  summary()
```


```{r}
fit <- glm(formula = my_formula, data = df_training, family = binomial)
summary(fit)

pred <- predict(fit, newdata = df_testing, type = "response")
summary(pred)
```

```{r}
set.seed(123)

df_1 <- df[, c("PERIODO", "COVER", "SEXO", "FUMADOR", "BUENA_SALUD", "EDAD_ACTUARIAL", "SINIESTRO", "EXP", "DURACION", "CAPITAL", "IMC")]

df_split_1 <- initial_split(data = df_1, prop = 3/4, strata = SINIESTRO)
df_train_1 <- training(df_split_1)
df_test_1  <- testing(df_split_1)
# cv
df_train_1_cv <- vfold_cv(df_train_1)

sin_recipe <- 
  recipe(SINIESTRO ~ ., data = df_1) %>%
  step_normalize(all_numeric()) %>%
  step_BoxCox(SINIESTRO)

df_train_preprocessed <- sin_recipe %>%
  prep(df_train_1) 
```

```{r}
rf_model <- 
  rand_forest() %>%
  set_args(mtry = tune()) %>%
  set_engine("ranger", importance = "impurity") %>%
  set_mode("classification") 

rf_workflow <- workflow() %>%
  add_recipe(sin_recipe) %>%
  add_model(rf_model)

rf_grid <- expand.grid(mtry = c(3, 4, 5))
# extract results
rf_tune_results <- rf_workflow %>%
  tune_grid(resamples = df_train_1_cv, #CV object
            grid = rf_grid, # grid of values to try
            metrics = metric_set(accuracy, roc_auc) # metrics we care about
            )

# print results
rf_tune_results %>%
  collect_metrics()
```











