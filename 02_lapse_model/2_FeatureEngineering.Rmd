---
title: '**Lapse: Feature Engineering**'
author: '*Roberto Jesús Alcaraz Molina*'
date: "04/05/2021"
output:
  prettydoc::html_pretty:
    theme: cayman
    df_print: paged
header-includes: 
- \usepackage{float}
- \usepackage{amsbsy}
- \usepackage{amsmath}
- \usepackage{graphicx}
- \usepackage{subfig}
- \usepackage{booktabs}
---

```{r include=FALSE}
knitr::opts_chunk$set(warning = FALSE, 
                      echo = T, 
                      message = FALSE,
                      fig.pos="H", 
                      fig.align="center",
                      fig.width=15,
                      cache=FALSE, error = TRUE)
```

```{r, echo = F}
# install.packages("pacman")
# devtools::install_github("stevenpawley/recipeselectors")
pacman::p_load(tidyverse, tidymodels, workflowsets, tune, patchwork, dotwhisker, doParallel, mgcv, performance, recipeselectors, vip)
theme_set(theme_bw())

# Models packages
pacman::p_load(ranger)
```

```{r}
lapse_data <- readRDS("../00_data/insurance_lapse.RDS")
lapse_data$lapse <- as.factor(lapse_data$lapse)
```

```{r}
set.seed(123)

lapse_split <- initial_split(lapse_data, prop = 0.7, strata = lapse)
lapse_train <- training(lapse_split)
lapse_test  <- testing(lapse_split)
```

In this step of the project, we will analyze the following things:

  - Variable selection through gam, drop (p-value > 0.2) and random forest.
  - Interaction between variables.
  - Preprocessing steps taking into account the EDA.
  

# Variable selection

## Recursive feature selection with Random Forest

```{r}
select_rec <- 
  recipe(lapse ~ period + cover + sex + smoker + good_health +
                   actuarial_age + duration + capital + IMC,
         data = lapse_train)

vip_model <- rand_forest() %>%
  set_engine("ranger", importance = "permutation") %>%
  set_mode("classification") %>%
  fit(lapse ~ ., data = select_rec %>% prep() %>% juice)


vip(vip_model)
```


```{r}
rfe_model <- rand_forest() %>%
  set_engine("ranger", importance = "permutation") %>%
  set_mode("classification")

# Predictive model for the deaths
set.seed(1234)
select_rec <- 
  recipe(lapse ~ cover + sex + smoker + good_health +
                   actuarial_age + duration + capital + IMC,
         data = lapse_train) %>%
  step_select_vip(all_predictors(), outcome = "lapse", model = rfe_model, top_p = 7)

new_data <- select_rec %>% prep() %>% juice()
new_data

# The recursive feature selection with Random Forest discard the variables smoker and good_health.
```


## GAM models

```{r}
gam_model <- gam(lapse ~ cover + sex + smoker + good_health +
                   s(actuarial_age) + s(duration) + s(capital) + s(IMC),
                 data = lapse_train, family = "binomial")
summary(gam_model)

# Parametric coefficients:
#                Estimate Std. Error z value Pr(>|z|)    
# (Intercept)    -1.62112    0.04886 -33.179   <2e-16 ***
# period2011      0.01432    0.01274   1.123   0.2613    
# period2012      0.73408    0.01230  59.663   <2e-16 ***
# cover2         -0.05201    0.02261  -2.300   0.0215 *  
# cover3         -0.02099    0.01781  -1.178   0.2386    
# sexwoman       -0.14673    0.01227 -11.955   <2e-16 ***
# smokeryes       0.11472    0.01373   8.358   <2e-16 ***
# good_healthyes -0.03360    0.04912  -0.684   0.4939    
# ---
# Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
# 
# Approximate significance of smooth terms:
#                    edf Ref.df   Chi.sq  p-value    
# s(actuarial_age) 8.446  8.858   383.14  < 2e-16 ***
# s(duration)      8.969  8.999 27571.25  < 2e-16 ***
# s(capital)       7.230  8.188   141.56  < 2e-16 ***
# s(IMC)           4.657  5.669    40.29 2.22e-06 ***


gam_model <- gam(lapse ~ period + cover + sex + smoker +
                   s(actuarial_age) + s(duration) + s(capital) + s(IMC),
                 data = lapse_train, family = "binomial")
summary(gam_model)

# Parametric coefficients:
#             Estimate Std. Error  z value Pr(>|z|)    
# (Intercept) -1.65361    0.01106 -149.530   <2e-16 ***
# period2011   0.01427    0.01274    1.119   0.2630    
# period2012   0.73399    0.01230   59.659   <2e-16 ***
# cover2      -0.05196    0.02261   -2.298   0.0216 *  
# cover3      -0.02096    0.01781   -1.177   0.2393    
# sexwoman    -0.14713    0.01226  -11.997   <2e-16 ***
# smokeryes    0.11476    0.01373    8.361   <2e-16 ***
# ---
# Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
# 
# Approximate significance of smooth terms:
#                    edf Ref.df   Chi.sq p-value    
# s(actuarial_age) 8.447  8.858   383.08  <2e-16 ***
# s(duration)      8.969  8.999 27653.30  <2e-16 ***
# s(capital)       7.229  8.187   141.37  <2e-16 ***
# s(IMC)           4.645  5.642    49.06  <2e-16 ***
# ---
# Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
# 
# R-sq.(adj) =  0.185   Deviance explained = 13.3%
# UBRE = -0.074846  Scale est. = 1         n = 264127
```

```{r}
prob <- predict(gam_model, newdata = lapse_train, 
                type = "response")

prob <- as_tibble(prob) %>%
  mutate(lapse = lapse_train$lapse)

pred_curve <- prob %>%
  roc_curve(lapse, value, event_level = "second")

thres <- pred_curve %>%
  mutate(sum = specificity + sensitivity) %>%
  filter(sum == max(sum)) %>%
  select(.threshold) %>%
  pull()

# thres <- 0.3487676
confusion_matrix <- prob %>%
  mutate(pred_class = as.factor(ifelse(value > thres,
                                       "yes", "no"))) %>%
  conf_mat(truth = lapse,
           estimate = pred_class)

confusion_matrix
confusion_matrix %>%
  summary(event_level = "second")

prob %>%
  roc_auc(lapse, value, event_level = "second")
autoplot(pred_curve)
```



## Interaction terms

```{r}
lapse_train_yes <- lapse_train %>%
  filter(lapse == "yes")

lapse_train_no <- lapse_train %>%
  filter(lapse == "no")
```

```{r}
# Interactions between the categorical variables:
## Period and cover YES
lapse_train %>%
  ggplot(aes(x = period, fill = cover)) +
  geom_bar(position = "dodge") +
  facet_wrap(~lapse) 

print("LAPSE: NO")
tab <- table(lapse_train_no$period, lapse_train_no$cover)*100/nrow(lapse_train_no)
cbind(tab, tab[, 2] / (tab[, 1] + tab[, 2]))
print("LAPSE: YES")
tab <- table(lapse_train_yes$period, lapse_train_yes$cover)*100/nrow(lapse_train_yes)
cbind(tab, tab[, 2] / (tab[, 1] + tab[, 2]))

## Period and sex YES
lapse_train %>%
  ggplot(aes(x = period, fill = sex)) +
  geom_bar(position = "dodge") +
  facet_wrap(~lapse) 

print("LAPSE: NO")
tab <- table(lapse_train_no$period, lapse_train_no$sex)*100/nrow(lapse_train_no)
cbind(tab, tab[, 2] / (tab[, 1] + tab[, 2]))
print("LAPSE: YES")
tab <- table(lapse_train_yes$period, lapse_train_yes$sex)*100/nrow(lapse_train_yes)
cbind(tab, tab[, 2] / (tab[, 1] + tab[, 2]))

## Period and smoker YES
lapse_train %>%
  ggplot(aes(x = period, fill = smoker)) +
  geom_bar(position = "dodge") +
  facet_wrap(~lapse) 

print("LAPSE: NO")
tab <- table(lapse_train_no$period, lapse_train_no$smoker)*100/nrow(lapse_train_no)
cbind(tab, tab[, 2] / (tab[, 1] + tab[, 2]))
print("LAPSE: YES")
tab <- table(lapse_train_yes$period, lapse_train_yes$smoker)*100/nrow(lapse_train_yes)
cbind(tab, tab[, 2] / (tab[, 1] + tab[, 2]))

# Sex and smoker YES
lapse_train %>%
  ggplot(aes(x = sex, fill = smoker)) +
  geom_bar(position = "dodge") +
  facet_wrap(~lapse) 

print("LAPSE: NO")
tab <- table(lapse_train_no$sex, lapse_train_no$smoker)*100/nrow(lapse_train_no)
cbind(tab, tab[, 2] / (tab[, 1] + tab[, 2]))
print("LAPSE: YES")
tab <- table(lapse_train_yes$sex, lapse_train_yes$smoker)*100/nrow(lapse_train_yes)
cbind(tab, tab[, 2] / (tab[, 1] + tab[, 2]))

# cover and sex
lapse_train %>%
  ggplot(aes(x = cover, fill = sex)) +
  geom_bar(position = "dodge") +
  facet_wrap(~lapse) 

print("LAPSE: NO")
tab <- table(lapse_train_no$cover, lapse_train_no$sex)*100/nrow(lapse_train_no)
cbind(tab, tab[, 2] / (tab[, 1] + tab[, 2]))
print("LAPSE: YES")
tab <- table(lapse_train_yes$cover, lapse_train_yes$sex)*100/nrow(lapse_train_yes)
cbind(tab, tab[, 2] / (tab[, 1] + tab[, 2]))

# cover and smoker
lapse_train %>%
  ggplot(aes(x = cover, fill = smoker)) +
  geom_bar(position = "dodge") +
  facet_wrap(~lapse) 

print("LAPSE: NO")
tab <- table(lapse_train_no$cover, lapse_train_no$smoker)*100/nrow(lapse_train_no)
cbind(tab, tab[, 2] / (tab[, 1] + tab[, 2]))
print("LAPSE: YES")
tab <- table(lapse_train_yes$cover, lapse_train_yes$smoker)*100/nrow(lapse_train_yes)
cbind(tab, tab[, 2] / (tab[, 1] + tab[, 2]))

# Sex and smoker
lapse_train %>%
  ggplot(aes(x = sex, fill = smoker)) +
  geom_bar(position = "dodge") +
  facet_wrap(~lapse) 

print("LAPSE: NO")
tab <- table(lapse_train_no$sex, lapse_train_no$smoker)*100/nrow(lapse_train_no)
cbind(tab, tab[, 2] / (tab[, 1] + tab[, 2]))
print("LAPSE: YES")
tab <- table(lapse_train_yes$sex, lapse_train_yes$smoker)*100/nrow(lapse_train_yes)
cbind(tab, tab[, 2] / (tab[, 1] + tab[, 2]))
```


```{r}
# Interactions between actuarial_age and the categorical variables:
a <- lapse_train %>%
  ggplot(aes(x = actuarial_age, color = sex, fill = sex)) +
  geom_density(alpha = 0.4)+
  facet_wrap(~lapse) 
b <- lapse_train %>%
  ggplot(aes(x = actuarial_age, color = smoker, fill = smoker)) +
  geom_density(alpha = 0.4)+
  facet_wrap(~lapse) 
c <- lapse_train %>%
  ggplot(aes(x = actuarial_age, color = good_health, fill = good_health)) +
  geom_density(alpha = 0.4)+
  facet_wrap(~lapse) 
d <- lapse_train %>%
  ggplot(aes(x = actuarial_age, color = IMC_factor_1, fill = IMC_factor_1)) +
  geom_density(alpha = 0.4)+
  facet_wrap(~lapse) 

a / b / c / d
```

```{r}
# Interactions between duration and the categorical variables:
a <- lapse_train %>%
  ggplot(aes(x = duration, color = sex, fill = sex)) +
  geom_density(alpha = 0.4)+
  facet_wrap(~lapse) 
b <- lapse_train %>%
  ggplot(aes(x = duration, color = smoker, fill = smoker)) +
  geom_density(alpha = 0.4)+
  facet_wrap(~lapse) 
c <- lapse_train %>%
  ggplot(aes(x = duration, color = good_health, fill = good_health)) +
  geom_density(alpha = 0.4)+
  facet_wrap(~lapse) 
d <- lapse_train %>%
  ggplot(aes(x = duration, color = IMC_factor_1, fill = IMC_factor_1)) +
  geom_density(alpha = 0.4)+
  facet_wrap(~lapse) 

a / b / c / d
```

```{r}
inter_model <- glm(lapse ~ period + cover + sex + smoker +
                   actuarial_age + duration + capital + IMC + (period + cover + sex + smoker)^2,
                 data = lapse_train, family = "binomial")

# Coefficients:
#                        Estimate Std. Error  z value Pr(>|z|)    
# (Intercept)          -2.243e-01  5.423e-02   -4.136 3.53e-05 ***
# period2011           -8.505e-02  1.747e-02   -4.868 1.13e-06 ***
# period2012            7.757e-01  1.669e-02   46.473  < 2e-16 ***
# cover2               -1.314e-01  4.548e-02   -2.888 0.003874 ** 
# cover3                9.620e-02  3.283e-02    2.930 0.003387 ** 
# sexwoman             -2.997e-01  1.973e-02  -15.189  < 2e-16 ***
# smokeryes             2.481e-01  2.419e-02   10.258  < 2e-16 ***
# actuarial_age        -1.285e-03  5.668e-04   -2.267 0.023390 *  
# duration             -2.437e-01  1.960e-03 -124.389  < 2e-16 ***
# capital              -9.015e-07  9.791e-08   -9.208  < 2e-16 ***
# IMC                  -7.016e-03  2.143e-03   -3.274 0.001059 ** 
# period2011:cover2     1.403e-02  5.612e-02    0.250 0.802527    
# period2012:cover2    -2.952e-03  5.283e-02   -0.056 0.955434    
# period2011:cover3     1.482e-02  4.186e-02    0.354 0.723336    
# period2012:cover3    -3.773e-01  4.142e-02   -9.110  < 2e-16 ***
# period2011:sexwoman   8.463e-02  2.567e-02    3.298 0.000975 ***
# period2012:sexwoman   2.332e-01  2.435e-02    9.577  < 2e-16 ***
# period2011:smokeryes  5.584e-02  3.159e-02    1.767 0.077154 .  
# period2012:smokeryes -6.358e-01  3.203e-02  -19.850  < 2e-16 ***
# cover2:sexwoman       1.681e-01  4.420e-02    3.803 0.000143 ***
# cover3:sexwoman       6.680e-02  3.671e-02    1.820 0.068823 .  
# cover2:smokeryes      9.057e-02  5.768e-02    1.570 0.116341    
# cover3:smokeryes      7.225e-02  4.259e-02    1.696 0.089816 .  
# sexwoman:smokeryes    1.911e-02  2.768e-02    0.690 0.489984    
# ---
# Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

inter_model <- glm(lapse ~ period + cover + sex + smoker +
                   actuarial_age + duration + capital + IMC + (period + cover + sex + smoker)^2 - sex:smoker,
                 data = lapse_train, family = "binomial")
summary(inter_model)
```

Now, we repeat the process:

```{r}
gam_model <- gam(lapse ~ period + cover + sex + smoker +
                   s(actuarial_age) + s(duration) + s(capital) + s(IMC) + (period + cover + sex + smoker)^2 - sex:smoker - cover:smoker,
                 data = lapse_train, family = "binomial")
summary(gam_model)

# Parametric coefficients:
#                       Estimate Std. Error  z value Pr(>|z|)    
# (Intercept)          -1.668622   0.013323 -125.239  < 2e-16 ***
# period2011           -0.005343   0.018069   -0.296  0.76746    
# period2012            0.799485   0.017376   46.010  < 2e-16 ***
# cover2               -0.112046   0.045055   -2.487  0.01289 *  
# cover3                0.093212   0.031967    2.916  0.00355 ** 
# sexwoman             -0.271162   0.020134  -13.468  < 2e-16 ***
# smokeryes             0.356736   0.022335   15.972  < 2e-16 ***
# period2011:cover2     0.007901   0.057660    0.137  0.89100    
# period2012:cover2    -0.017057   0.054441   -0.313  0.75405    
# period2011:cover3     0.007662   0.042756    0.179  0.85778    
# period2012:cover3    -0.401171   0.042433   -9.454  < 2e-16 ***
# period2011:sexwoman   0.052921   0.026461    2.000  0.04550 *  
# period2012:sexwoman   0.248670   0.025211    9.864  < 2e-16 ***
# period2011:smokeryes  0.024249   0.032396    0.749  0.45414    
# period2012:smokeryes -0.749433   0.033019  -22.697  < 2e-16 ***
# cover2:sexwoman       0.143591   0.045597    3.149  0.00164 ** 
# cover3:sexwoman       0.065737   0.037694    1.744  0.08117 .  
# ---
# Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
# 
# Approximate significance of smooth terms:
#                    edf Ref.df   Chi.sq p-value    
# s(actuarial_age) 8.462  8.865   398.75  <2e-16 ***
# s(duration)      8.973  9.000 27812.00  <2e-16 ***
# s(capital)       7.179  8.147   139.03  <2e-16 ***
# s(IMC)           4.670  5.668    48.42  <2e-16 ***
```

```{r}
prob <- predict(gam_model, newdata = lapse_train, 
                type = "response")

prob <- as_tibble(prob) %>%
  mutate(lapse = lapse_train$lapse)

pred_curve <- prob %>%
  roc_curve(lapse, value, event_level = "second")

thres <- pred_curve %>%
  mutate(sum = specificity + sensitivity) %>%
  filter(sum == max(sum)) %>%
  select(.threshold) %>%
  pull()

# thres <- 0.3343441
confusion_matrix <- prob %>%
  mutate(pred_class = as.factor(ifelse(value > thres,
                                       "yes", "no"))) %>%
  conf_mat(truth = lapse,
           estimate = pred_class)

confusion_matrix
confusion_matrix %>%
  summary(event_level = "second")

prob %>%
  roc_auc(lapse, value, event_level = "second")
autoplot(pred_curve)
```



# Preprocessing steps:

After seeing some description of the variables, their effect on the model and their interactions, the preprocessing steps we are going to follow are:

