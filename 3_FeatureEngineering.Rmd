---
title: '**TFM: Feature Engineering**'
author: '*Roberto Jes√∫s Alcaraz Molina*'
date: "14/04/2021"
output:
  html_document:
    toc: T
    fig_caption: yes
header-includes: 
- \usepackage{float}
- \usepackage{amsbsy}
- \usepackage{amsmath}
- \usepackage{graphicx}
- \usepackage{subfig}
- \usepackage{booktabs}
---

```{r include=FALSE}
knitr::opts_chunk$set(warning = FALSE, 
                      echo = F, 
                      message = FALSE,
                      fig.pos="H", 
                      fig.align="center",
                      fig.width=15,
                      cache=FALSE, error = TRUE)
```

```{r, echo = F}
# install.packages("pacman")
pacman::p_load(tidyverse, tidymodels, workflowsets, tune, patchwork, FactoMineR, doParallel)
theme_set(theme_bw())

# Models packages
pacman::p_load(ranger)
```

# Necessary code
```{r}
insurance <- readRDS("insurance.RDS")
insurance_mortality <- readRDS("insurance_mortality.RDS")
insurance_lapse <- readRDS("insurance_lapse.RDS")


set.seed(123)

insurance_split <- initial_split(insurance, 
                                 prop = 0.7, 
                                 strata = mortality)

insurance_train <- training(insurance_split)
insurance_test <- testing(insurance_split)

# Recipe
rec <- 
  recipe(mortality ~ period + cover + sex + smoker + good_health + actuarial_age + exp + duration + capital + IMC,
         data = insurance_train)

# Model
glm_model <- logistic_reg() %>%
  set_engine("glm")

# Workflow
glm_workflow <- workflow() %>%
  add_model(glm_model) %>%
  add_recipe(rec)
```

# A simple model

Recipe:
```{r}
# Formula
rec <- 
  recipe(mortality ~ period + cover + sex + smoker + good_health + actuarial_age + duration + capital + IMC, data = insurance_train)

# Preprocessing steps
rec <- rec %>%
  themis::step_upsample(mortality, over_ratio = 0.01) %>%
  step_dummy(all_nominal(), -all_outcomes()) %>%
  step_log(capital, IMC, base = 10)

# Data preprocessed
insurance_train_prep <- rec %>%
  prep() %>%
  bake(new_data = NULL)

summary(insurance_train_prep$mortality)
```

Model and workflow:
```{r}
glm_model <- logistic_reg() %>%
  set_engine("glm")

glm_wflow <- workflow() %>%
  add_model(glm_model) %>%
  add_recipe(rec)
```

Fitting the model and description
```{r}
glm_fit <- fit(glm_wflow, insurance_train)
tidy(glm_fit) %>% 
  dwplot(dot_args = list(size = 2, color = "black"),
         whisker_args = list(color = "black"),
         vline = geom_vline(xintercept = 0, colour = "grey50", linetype = 2))
```

Prediction in the training set and roc curve:
```{r}
pred <- predict(glm_fit, insurance_train)
prob <- predict(glm_fit, insurance_train, type = "prob")

pred <- pred %>%
  mutate(mortality = insurance_train$mortality)

pred %>%
  conf_mat(truth = mortality,
           estimate = .pred_class)

pred %>%
  conf_mat(truth = mortality,
           estimate = .pred_class) %>%
  summary()

prob <- prob %>%
  mutate(mortality = insurance_train$mortality)
pred_curve <- prob %>%
  roc_curve(mortality, .pred_yes, event_level = "second")
prob %>%
  roc_auc(mortality, .pred_no)
autoplot(pred_curve)
```

# Using recipes

Now, we will add some interaction terms

```{r}
# Formula
rec <- 
  recipe(mortality ~ period + cover + sex + smoker + good_health + actuarial_age + duration + capital + IMC, data = insurance_train)

# Preprocessing steps
rec <- rec %>%
  themis::step_upsample(mortality, over_ratio = 0.01) %>%
  step_dummy(all_nominal(), -all_outcomes()) %>%
  step_log(capital, IMC, base = 10)

# Adding interaction terms
rec <- rec %>%
  step_interact(~ )
```















