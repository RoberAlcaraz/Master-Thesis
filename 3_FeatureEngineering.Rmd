---
title: '**TFM: Feature Engineering**'
author: '*Roberto Jes√∫s Alcaraz Molina*'
date: "14/04/2021"
output:
  html_document:
    toc: T
    fig_caption: yes
header-includes: 
- \usepackage{float}
- \usepackage{amsbsy}
- \usepackage{amsmath}
- \usepackage{graphicx}
- \usepackage{subfig}
- \usepackage{booktabs}
---

```{r include=FALSE}
knitr::opts_chunk$set(warning = FALSE, 
                      echo = F, 
                      message = FALSE,
                      fig.pos="H", 
                      fig.align="center",
                      fig.width=15,
                      cache=FALSE, error = TRUE)
```

```{r, echo = F}
# install.packages("pacman")
pacman::p_load(tidyverse, tidymodels, workflowsets, tune, patchwork, FactoMineR, doParallel)
theme_set(theme_bw())

# Models packages
pacman::p_load(ranger)
```

# Necessary code
```{r}
insurance <- readRDS("insurance.RDS")
insurance_mortality <- readRDS("insurance_mortality.RDS")
insurance_lapse <- readRDS("insurance_lapse.RDS")


set.seed(123)

# insurance_split <- initial_split(insurance, prop = 0.7, strata = mortality)
# insurance_train <- training(insurance_split)
# insurance_test <- testing(insurance_split)

# Recipe
rec <- 
  recipe(mortality ~ period + cover + sex + smoker + good_health + actuarial_age + duration + capital + IMC,
         data = insurance)

# Model
glm_model <- logistic_reg() %>%
  set_engine("glm")

# Workflow
glm_wflow <- workflow() %>%
  add_model(glm_model) %>%
  add_recipe(rec)
```


In this step of the project, we will analyze the following things:

  - Variable selection through drop (p-value > 0.2).
  - Interaction between variables.
  - Preprocessing steps taking into account the EDA.

# Variable selection

First of all, before doing any interaction between all the variables, we will fit a simple logistic regression model to see which variables have an effect on the outcome and which does not, removing those whose p-value is greater than 0.2.

```{r}
glm_fit <- fit(glm_wflow, insurance)
tidy(glm_fit) %>% 
  # filter(p.value > 0.2) %>%
  dwplot(dot_args = list(size = 2, color = "black"),
         whisker_args = list(color = "black"),
         vline = geom_vline(xintercept = 0, colour = "grey50", linetype = 2))


## Also, we are going to fit the same model with in the traditional way to be able to do the drop1
glm_drop <- glm(mortality ~ period + cover + sex + smoker + good_health + actuarial_age + duration + capital + IMC, data = insurance, family = "binomial")

drop1(glm_drop, test = "LRT")
drop1(update(glm_drop, as.formula(paste(".~.- cover"))), test = "LRT")
drop1(update(glm_drop, as.formula(paste(".~.- cover - IMC"))), test = "LRT")
drop1(update(glm_drop, as.formula(paste(".~.- cover - IMC - capital"))), test = "LRT")
drop1(update(glm_drop, as.formula(paste(".~.- cover - IMC - capital - period"))), test = "LRT")
```

Therefore, we will remove the variables cover, duration and period from our model, and we could create an inferential model to explain better the mortality in terms of the predictors

### Inferential model
```{r}
set.seed(23)
# Recipe
rec <- 
  recipe(mortality ~ sex + smoker + good_health + actuarial_age + duration, 
         data = insurance) %>%
  themis::step_upsample(mortality, over_ratio = 0.01)

# Model
glm_model <- logistic_reg() %>%
  set_engine("glm")

# Workflow
glm_wflow <- workflow() %>%
  add_model(glm_model) %>%
  add_recipe(rec)

glm_fit <- fit(glm_wflow, insurance)
tidy(glm_fit) %>% 
  dwplot(dot_args = list(size = 2, color = "black"),
         whisker_args = list(color = "black"),
         vline = geom_vline(xintercept = 0, colour = "grey50", linetype = 2))

tidy(glm_fit) %>%
  mutate(
    odds_ratio = exp(estimate)
  ) %>%
  select(term, odds_ratio)
```

For instance, we can observe that if you were a woman, the odds of mortality are 0.48 times lower than if you were a man. However, this model is saying that if you had good health, the odds of mortality are 1.68 times bigger than if you had a bad health, which does not make much sense.

Now, if we change the variables `IMC` and `capital` for their transformed variables, we can see if our inferential model could explain better.

```{r}
## Also, we are going to fit the same model with in the traditional way to be able to do the drop1
glm_drop <- glm(mortality ~ period + cover + sex + smoker + good_health + actuarial_age + duration + capital_factor_2 + IMC_factor_1, data = insurance, family = "binomial")

drop1(glm_drop, test = "LRT")
drop1(update(glm_drop, as.formula(paste(".~.- capital_factor_2"))), test = "LRT")
drop1(update(glm_drop, as.formula(paste(".~.- capital_factor_2 - cover"))), test = "LRT")
drop1(update(glm_drop, as.formula(paste(".~.- capital_factor_2 - cover - period"))), test = "LRT")
```

```{r}
set.seed(23)
# Recipe
rec <- 
  recipe(mortality ~ sex + smoker + good_health + actuarial_age + duration + IMC_factor_1,
         data = insurance) %>%
  themis::step_upsample(mortality, over_ratio = 0.01)

# Model
glm_model <- logistic_reg() %>%
  set_engine("glm")

# Workflow
glm_wflow <- workflow() %>%
  add_model(glm_model) %>%
  add_recipe(rec)

glm_fit <- fit(glm_wflow, insurance)
tidy(glm_fit) %>% 
  dwplot(dot_args = list(size = 2, color = "black"),
         whisker_args = list(color = "black"),
         vline = geom_vline(xintercept = 0, colour = "grey50", linetype = 2))

tidy(glm_fit) %>%
  mutate(
    odds_ratio = exp(estimate)
  ) %>%
  select(term, odds_ratio) %>%
  ggplot(aes(x = odds_ratio, y = term)) +
  geom_point(size = 2) + geom_vline(xintercept = 1, )
```



# Interaction terms

Now, our model is going to be formed by the variables sex, smoker, good_health, actuarial_age, capital and IMC. Regarding the interactions, we can add interaction terms between two categorical variables, or between one categorical and one numerical.

```{r}
# Interactions between the categorical variables:
insurance %>%
  ggplot(aes(x = sex, fill = smoker)) +
  geom_bar()
tab <- table(insurance$sex, insurance$smoker)*100/nrow(insurance)
cbind(tab, tab[, 2] / (tab[, 1] + tab[, 2]))

insurance %>%
  ggplot(aes(x = sex, fill = good_health)) +
  geom_bar()
tab <- table(insurance$sex, insurance$good_health)*100/nrow(insurance)
cbind(tab, tab[, 2] / (tab[, 1] + tab[, 2]))

insurance %>%
  ggplot(aes(x = smoker, fill = good_health)) +
  geom_bar()
tab <- table(insurance$smoker, insurance$good_health)*100/nrow(insurance)
cbind(tab, tab[, 2] / (tab[, 1] + tab[, 2]))
```

```{r}
# Interactions between actuarial_age and the categorical variables:
a <- insurance %>%
  ggplot(aes(x = actuarial_age, color = sex, fill = sex)) +
  geom_density(alpha = 0.4)
b <- insurance %>%
  ggplot(aes(x = actuarial_age, color = smoker, fill = smoker)) +
  geom_density(alpha = 0.4)
c <- insurance %>%
  ggplot(aes(x = actuarial_age, color = good_health, fill = good_health)) +
  geom_density(alpha = 0.4)

a / b / c
```

```{r}
# Interactions between capital and the categorical variables:
a <- insurance %>%
  ggplot(aes(x = capital, color = sex, fill = sex)) +
  scale_x_log10() +
  geom_density(alpha = 0.4)
b <- insurance %>%
  ggplot(aes(x = capital, color = smoker, fill = smoker)) +
  scale_x_log10() +
  geom_density(alpha = 0.4)
c <- insurance %>%
  ggplot(aes(x = capital, color = good_health, fill = good_health)) +
  scale_x_log10() +
  geom_density(alpha = 0.4)

a / b / c
```
```{r}
# Interactions between IMC and the categorical variables:
a <- insurance %>%
  ggplot(aes(x = IMC, color = sex, fill = sex)) +
  scale_x_log10() +
  geom_density(alpha = 0.4)
b <- insurance %>%
  ggplot(aes(x = IMC, color = smoker, fill = smoker)) +
  scale_x_log10() +
  geom_density(alpha = 0.4)
c <- insurance %>%
  ggplot(aes(x = IMC, color = good_health, fill = good_health)) +
  scale_x_log10() +
  geom_density(alpha = 0.4)

a / b / c
```


```{r}
max_model <- glm(mortality ~ (sex + smoker + good_health + actuarial_age + capital + IMC)^2 -
                   actuarial_age:capital - actuarial_age:IMC - capital:IMC, # no interaction between numerical
         data = insurance, family = "binomial")
summary(max_model)

min_model <- glm(mortality ~ 1, data = insurance, family = "binomial")

step_model <- stats::step(max_model,
                          direction = "backward", 
                          scope = list(upper = max_model, lower = min_model), 
                          trace = 0)
```
# Preprocessing steps:

After seeing some description of the variables, their effect on the model and their interactions, the preprocessing steps we are going to follow are:

1. A method of resampling for the unbalanced class (e.g. `step_upsample(mortality)`).
2. Convert to dummy variables all categorical since it is usually useful for the majority of models.
3. For the numeric variables `capital` and `IMC`, we will apply the log10 for making them symmetric.
4. Based on the AIC, we will include the interactions: sex:capital, smoker:good_health and good_health:capital

Also, for some models, it is mandatory to scale and center the variables, but for the moment, we are not going to do it.


```{r}
set.seed(23)

# Formula
rec <- recipe(mortality ~ sex + smoker + good_health + actuarial_age + capital + IMC, data = insurance)

# Preprocessing steps
rec <- rec %>%
  themis::step_upsample(mortality, over_ratio = 0.01) %>%
  step_dummy(all_nominal(), -all_outcomes()) %>%
  step_log(capital, IMC, base = 10) %>%
  step_interact(terms = ~ capital:starts_with("sex") +
                  starts_with("smoker"):starts_with("good_health") +
                  capital:starts_with("good_health"))

# Data preprocessed
insurance_prep <- rec %>%
  prep() %>%
  bake(new_data = NULL)

summary(insurance_prep$mortality)
```

Model and workflow:
```{r}
glm_model <- logistic_reg() %>%
  set_engine("glm")

glm_wflow <- workflow() %>%
  add_model(glm_model) %>%
  add_recipe(rec)

glm_fit <- fit(glm_wflow, insurance)
```

Prediction in the training set and roc curve:
```{r}
pred <- predict(glm_fit, insurance)
prob <- predict(glm_fit, insurance, type = "prob")

pred <- pred %>%
  mutate(mortality = insurance$mortality)

pred %>%
  conf_mat(truth = mortality,
           estimate = .pred_class)

pred %>%
  conf_mat(truth = mortality,
           estimate = .pred_class) %>%
  summary()

prob <- prob %>%
  mutate(mortality = insurance$mortality)
pred_curve <- prob %>%
  roc_curve(mortality, .pred_yes, event_level = "second")
prob %>%
  roc_auc(mortality, .pred_no)
autoplot(pred_curve)
```
















