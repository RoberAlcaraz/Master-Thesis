---
title: '**Mortality: Model tuning and selection**'
author: '*Roberto Jes√∫s Alcaraz Molina*'
date: "14/04/2021"
output:
  html_document:
    toc: T
    fig_caption: yes
header-includes: 
- \usepackage{float}
- \usepackage{amsbsy}
- \usepackage{amsmath}
- \usepackage{graphicx}
- \usepackage{subfig}
- \usepackage{booktabs}
---

```{r include=FALSE}
knitr::opts_chunk$set(warning = FALSE, 
                      echo = F, 
                      message = FALSE,
                      fig.pos="H", 
                      fig.align="center",
                      fig.width=15,
                      cache=FALSE, error = TRUE)
```

```{r, echo = F}
# install.packages("pacman")
pacman::p_load(tidyverse, tidymodels, workflowsets, tune, patchwork, FactoMineR, doParallel, usemodels)
theme_set(theme_bw())

# Models packages
pacman::p_load(ranger, baguette)
```

## Code

```{r, eval = T}
insurance <- readRDS("../0_data/insurance.RDS")

set.seed(23)
insurance_folds <- vfold_cv(insurance, v = 3, strata = mortality)

# Model
glm_model <- logistic_reg() %>%
  set_engine("glm")

# Workflow
glm_wflow <- workflow() %>%
  add_model(glm_model)
```

To start, we are going to compare multiple models with different features or preprocessing methods but the model for all of them is going to be the same: glm

```{r}
keep_pred <- control_resamples(save_pred = TRUE)

base <- recipe(mortality ~ period + cover + sex + smoker + good_health + actuarial_age + duration + capital + IMC, data = insurance) %>%
  themis::step_upsample(mortality, over_ratio = 0.01) %>%
  step_dummy(all_nominal_predictors()) %>%
  step_log(capital, IMC, base = 10)

base_1 <- recipe(mortality ~ period + sex + smoker + good_health + actuarial_age + duration + capital + IMC, data = insurance) %>%
  themis::step_upsample(mortality, over_ratio = 0.01) %>%
  step_dummy(all_nominal_predictors()) %>%
  step_log(capital, IMC, base = 10)

base_2 <- recipe(mortality ~ period + sex + smoker + good_health + actuarial_age + duration + capital, data = insurance) %>%
  themis::step_upsample(mortality, over_ratio = 0.01) %>%
  step_dummy(all_nominal_predictors()) %>%
  step_log(capital, base = 10)

base_3 <- recipe(mortality ~ period + sex + smoker + good_health + actuarial_age + duration, data = insurance) %>%
  themis::step_upsample(mortality, over_ratio = 0.01) %>%
  step_dummy(all_nominal_predictors()) 

base_4 <- recipe(mortality ~ period + sex + smoker + good_health + actuarial_age, data = insurance) %>%
  themis::step_upsample(mortality, over_ratio = 0.01) %>%
  step_dummy(all_nominal_predictors())

cat <- recipe(mortality ~ period + cover + sex + smoker + good_health + actuarial_age + duration + capital_factor_2 + IMC_factor_2, data = insurance) %>%
  themis::step_upsample(mortality, over_ratio = 0.01) %>%
  step_dummy(all_nominal_predictors())

cat_1 <- recipe(mortality ~ period + cover + sex + smoker + good_health + actuarial_age + duration + IMC_factor_2, data = insurance) %>%
  themis::step_upsample(mortality, over_ratio = 0.01) %>%
  step_dummy(all_nominal_predictors())

cat_2 <- recipe(mortality ~ period + sex + smoker + good_health + actuarial_age + duration + IMC_factor_2, data = insurance) %>%
  themis::step_upsample(mortality, over_ratio = 0.01) %>%
  step_dummy(all_nominal_predictors())

cat_3 <- recipe(mortality ~ sex + smoker + good_health + actuarial_age + duration + IMC_factor_2, data = insurance) %>%
  themis::step_upsample(mortality, over_ratio = 0.01) %>%
  step_dummy(all_nominal_predictors())

set_predictors <- list(
  # original
  base   = base,
  base_1 = base_1,
  base_2 = base_2, 
  base_3 = base_3,
  base_4 = base_4,
  cat    = cat,  
  cat_1  = cat_1, 
  cat_2  = cat_2, 
  cat_3  = cat_3
)

glm_models <- workflow_set(set_predictors, list(glm = glm_model), cross = F)
glm_models
```

```{r, eval=F}
cl <- makePSOCKcluster(6)
registerDoParallel(cl)

# fit here

stopCluster(cl)
```


```{r, eval = F}
cl <- makePSOCKcluster(6)
registerDoParallel(cl)

glm_models <- 
  glm_models %>% 
  workflow_map("fit_resamples", 
               # Options to `workflow_map()`: 
               seed = 23, verbose = TRUE,
               # Options to `fit_resamples()`: 
               resamples = insurance_folds, control = keep_pred,
               metrics = metric_set(roc_auc, kap))

stopCluster(cl)

# i 1 of 9 resampling: base_glm
# v 1 of 9 resampling: base_glm (38.2s)
# i 2 of 9 resampling: base_1_glm
# v 2 of 9 resampling: base_1_glm (16.4s)
# i 3 of 9 resampling: base_2_glm
# v 3 of 9 resampling: base_2_glm (13.1s)
# i 4 of 9 resampling: base_3_glm
# v 4 of 9 resampling: base_3_glm (11.3s)
# i 5 of 9 resampling: base_4_glm
# v 5 of 9 resampling: base_4_glm (11s)
# i 6 of 9 resampling: cat_glm
# v 6 of 9 resampling: cat_glm (12.6s)
# i 7 of 9 resampling: cat_1_glm
# v 7 of 9 resampling: cat_1_glm (14.1s)
# i 8 of 9 resampling: cat_2_glm
# v 8 of 9 resampling: cat_2_glm (11.1s)
# i 9 of 9 resampling: cat_3_glm
# v 9 of 9 resampling: cat_3_glm (10.4s)

# i 1 of 9 resampling: base_glm
# v 1 of 9 resampling: base_glm (41.4s)
# i 2 of 9 resampling: base_1_glm
# v 2 of 9 resampling: base_1_glm (40.5s)
# i 3 of 9 resampling: base_2_glm
# v 3 of 9 resampling: base_2_glm (39.2s)
# i 4 of 9 resampling: base_3_glm
# v 4 of 9 resampling: base_3_glm (34.6s)
# i 5 of 9 resampling: base_4_glm
# v 5 of 9 resampling: base_4_glm (32.8s)
# i 6 of 9 resampling: cat_glm
# v 6 of 9 resampling: cat_glm (38.8s)
# i 7 of 9 resampling: cat_1_glm
# v 7 of 9 resampling: cat_1_glm (36.9s)
# i 8 of 9 resampling: cat_2_glm
# v 8 of 9 resampling: cat_2_glm (37.3s)
# i 9 of 9 resampling: cat_3_glm
# v 9 of 9 resampling: cat_3_glm (31.3s)
```

```{r}
saveRDS(glm_models, "glm_models.RDS")
```

```{r}
collect_metrics(glm_models, summarize = T)


best_glm_model <- glm_models %>% 
  pull_workflow_set_result("base_3_glm") 

predictions <- collect_predictions(best_glm_model)

predictions %>%
  conf_mat(truth = mortality, estimate = .pred_class)
```

```{r}
autoplot(glm_models, metric = "roc_auc")
```


# Machine learning


```{r}
cl <- makePSOCKcluster(6)
registerDoParallel(cl)

tree_rpart_recipe <- 
  recipe(formula = mortality ~ period + cover + sex + smoker + good_health + 
    actuarial_age + duration + capital + IMC, data = insurance) %>%
  themis::step_upsample(mortality, over_ratio = 0.01)

tree_rpart_spec <-
  baguette::bag_tree() %>%
  set_engine('rpart') %>%
  set_mode('classification')

tree_rpart_wflow <- 
  workflow() %>% 
  add_recipe(tree_rpart_recipe) %>% 
  add_model(tree_rpart_spec) 

set.seed(56931)
tree_rpart_tune <-
  tree_rpart_wflow %>%
  fit_resamples(resamples = insurance_folds,
                control = keep_pred, 
                metrics = metric_set(roc_auc, kap))

stopCluster(cl)

collect_metrics(tree_rpart_tune)
predictions <- collect_predictions(tree_rpart_tune)

predictions %>%
  conf_mat(truth = mortality, estimate = .pred_class)
```
















