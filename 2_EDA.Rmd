---
title: '**TFM: Exploratory Data Analysis (EDA)**'
author: '*Roberto Jes√∫s Alcaraz Molina*'
date: "14/04/2021"
output:
  prettydoc::html_pretty:
    theme: cayman
    df_print: paged
header-includes: 
- \usepackage{float}
- \usepackage{amsbsy}
- \usepackage{amsmath}
- \usepackage{graphicx}
- \usepackage{subfig}
- \usepackage{booktabs}
---

```{r include=FALSE}
knitr::opts_chunk$set(warning = FALSE, 
                      echo = T, 
                      message = FALSE,
                      fig.pos="H", 
                      fig.align="center",
                      fig.width=15,
                      cache=FALSE, error = TRUE)
```

```{r, echo = F}
# install.packages("pacman")
pacman::p_load(tidyverse, tidymodels, workflows, tune, patchwork, FactoMineR, dotwhisker, splines)
theme_set(theme_bw())

# Models packages
pacman::p_load(ranger)
```

```{r}
insurance <- readRDS("insurance.RDS")
insurance_mortality <- readRDS("insurance_mortality.RDS")
insurance_lapse <- readRDS("insurance_lapse.RDS")
```


# Description and visualization of the variables

Our variables are:

- **Indicative variables**:

  - `ID`
  - `key`

- **Categorical variables (10 + 1)**:

  - `mortality` (target)
  - `period`
  - `cover`
  - `sex`
  - `smoker`
  - `good_health`
  - `capital_factor_1`
  - `capital_factor_2`
  - `capital_factor_3`
  - `IMC_factor_1`
  - `IMC_factor_2`


- **Numerical variables (7)**:

  - `actuarial_age`
  - `sus_age`
  - `exp`
  - `duration`
  - `duration_cat`
  - `capital`
  - `IMC`

## Target variable: `mortality`

```{r}
# mortality
table(insurance$mortality)/nrow(insurance)
```

We are going to split the data in 70% for training and 30% for testing
```{r}
set.seed(123)


insurance_split <- initial_split(insurance, prop = 0.7, strata = mortality)

insurance_train <- training(insurance_split)
summary(insurance$mortality)
insurance_test  <- testing(insurance_split)
summary(insurance_test$mortality)
```

Now, doing a simple model we can see that it is not useful:
```{r}
rec <- 
  recipe(mortality ~ period + cover + sex + smoker + good_health + actuarial_age + exp +
           duration + capital + IMC, data = insurance_train)

glm_model <- logistic_reg() %>%
  set_engine("glm")

glm_wflow <- workflow() %>%
  add_recipe(rec) %>%
  add_model(glm_model)

glm_fit <- fit(glm_wflow, insurance_train)
pred <- predict(glm_fit, insurance_test)

pred <- pred %>%
  mutate(mortality = insurance_test$mortality)
pred %>%
  conf_mat(truth = mortality,
           estimate = .pred_class)

#           Truth
# Prediction     no    yes
#        no  113279     66
#        yes      0      0
```


## Categorical variables (10 + 1)

- `period`
- `cover`
- `sex`
- `smoker`
- `good_health`
- `capital_factor_1`
- `capital_factor_2`
- `capital_factor_3`
- `IMC_factor_1`
- `IMC_factor_2`

### Period

```{r}
table(insurance_train$period)/nrow(insurance_train)

insurance_train %>%
  ggplot(aes(x = period)) +
  geom_bar() 

tab <- table(insurance_train$period, insurance_train$mortality)
cbind(tab, tab[, 2] / (tab[, 1] + tab[, 2]))
```

### Cover
```{r}
table(insurance_train$cover)/nrow(insurance_train)

insurance_train %>%
  ggplot(aes(x = cover)) +
  geom_bar() 

tab <- table(insurance_train$cover, insurance_train$mortality)
cbind(tab, tab[, 2] / (tab[, 1] + tab[, 2]))

# as we increase the number of coverages, the proportion increases
```

### sex
```{r}
table(insurance_train$sex)/nrow(insurance_train)

insurance_train %>%
  ggplot(aes(x = sex)) +
  geom_bar() 

tab <- table(insurance_train$sex, insurance_train$mortality)
cbind(tab, tab[, 2] / (tab[, 1] + tab[, 2]))

# almost double in men
```

### smoker
```{r}
table(insurance_train$smoker)/nrow(insurance_train)

insurance_train %>%
  ggplot(aes(x = smoker)) +
  geom_bar() 

tab <- table(insurance_train$smoker, insurance_train$mortality)
cbind(tab, tab[, 2] / (tab[, 1] + tab[, 2]))

# almost double in smokers
```

### good_health 
```{r}
table(insurance_train$good_health)/nrow(insurance_train)
insurance_train %>%
  ggplot(aes(x = good_health)) +
  geom_bar() 
tab <- table(insurance_train$good_health, insurance_train$mortality)
cbind(tab, tab[, 2] / (tab[, 1] + tab[, 2]))

# slightly higher for the people without good health
```

### capital_DESC
```{r}
table(insurance_train$capital_factor_1)/nrow(insurance_train)
insurance_train %>%
  ggplot(aes(x = capital_factor_1)) +
  geom_bar() 

tab <- table(insurance_train$capital_factor_1, insurance_train$mortality)
cbind(tab, tab[, 2] / (tab[, 1] + tab[, 2]))
# since we have many cateogories, we should think about encoding it.


table(insurance_train$capital_factor_2)/nrow(insurance_train)
insurance_train %>%
  ggplot(aes(x = capital_factor_2)) +
  geom_bar() 
tab <- table(insurance_train$capital_factor_2, insurance_train$mortality)
cbind(tab, tab[, 2] / (tab[, 1] + tab[, 2]))
# we should convert it to dummy. Lower proportion of mortalitys in the last group

table(insurance_train$capital_factor_3)/nrow(insurance_train)
insurance_train %>%
  ggplot(aes(x = capital_factor_3)) +
  geom_bar() 
tab <- table(insurance_train$capital_factor_3, insurance_train$mortality)
cbind(tab, tab[, 2] / (tab[, 1] + tab[, 2]))
# convert it to dummy
```

### IMC_DESC

```{r}
table(insurance_train$IMC_factor_1)/nrow(insurance_train)
insurance_train %>%
  ggplot(aes(x = IMC_factor_1)) +
  geom_bar() 

tab <- table(insurance_train$IMC_factor_1, insurance_train$mortality)
cbind(tab, tab[, 2] / (tab[, 1] + tab[, 2]))

table(insurance_train$IMC_factor_2)/nrow(insurance_train)
insurance_train %>%
  ggplot(aes(x = IMC_factor_2)) +
  geom_bar() 

tab <- table(insurance_train$IMC_factor_2, insurance_train$mortality)
cbind(tab, tab[, 2] / (tab[, 1] + tab[, 2]))

# the two of them are very similar. Double in people with risk/overweight
```

## Numerical variables (7)

- `actuarial_age`
- `sus_age`
- `exp`
- `duration`
- `duration_cat`
- `capital`
- `IMC`


### actuarial and suscription age
```{r}

insurance_train %>%
  ggplot(aes(x = actuarial_age)) +
  geom_histogram(aes(y=..density..), colour="black", fill="white")+
  geom_density(alpha=.2, fill="#FF6666") 
# seems good

# sus_age
insurance_train %>%
  ggplot(aes(x = sus_age)) +
  geom_histogram(aes(y=..density..), colour="black", fill="white")+
  geom_density(alpha=.2, fill="#FF6666") 
```

### exp

```{r}
table(ifelse(insurance_train$exp == 1, "=1", "<1"))/nrow(insurance_train)
insurance_train %>%
  ggplot(aes(x = exp)) +
  geom_histogram(aes(y=..density..), colour="black", fill="white")+
  geom_density(alpha=.2, fill="#FF6666")
```

### duration
```{r}
insurance_train %>%
  ggplot(aes(x = duration)) +
  geom_histogram(aes(y=..density..), colour="black", fill="white")+
  geom_density(alpha=.2, fill="#FF6666") 

# duration_cat
insurance_train %>%
  ggplot(aes(x = duration_cat)) +
  geom_histogram(aes(y=..density..), colour="black", fill="white")+
  geom_density(alpha=.2, fill="#FF6666") 
```
### Capital
```{r}
summary(insurance_train$capital)
insurance_train %>%
  ggplot(aes(x = capital)) +
  geom_histogram(aes(y=..density..), colour="black", fill="white")+
  geom_density(alpha=.2, fill="#FF6666") 

insurance_train %>%
  filter(capital > 2000000)

insurance_train %>%
  ggplot(aes(x = capital)) +
  geom_histogram(aes(y=..density..), colour="black", fill="white")+
  geom_density(alpha=.2, fill="#FF6666") +
  scale_x_log10()
# here we have some outliers. We should take it into account.
```


### IMC
```{r}
summary(insurance_train$IMC)

insurance_train %>%
  ggplot(aes(x = IMC)) +
  geom_histogram(aes(y=..density..), colour="black", fill="white")+
  geom_density(alpha=.2, fill="#FF6666") 

insurance_train %>%
  ggplot(aes(x = IMC)) +
  geom_histogram(aes(y=..density..), colour="black", fill="white")+
  geom_density(alpha=.2, fill="#FF6666") +
  scale_x_log10()

# Some outliers too
```

```{r}
names(insurance_train)

(a <- cor(insurance_train[, c(8, 10, 12, 14, 15)]))
corrplot::corrplot(a)

insurance_train %>%
  ggplot(aes(x = capital, y = IMC)) +
  geom_point()
# we have no linear correlation between the numerical variables
```

## Interaction terms:

We can add interaction terms between two categorical variables, or one categorical and one numerical.

```{r}
insurance_train %>%
  ggplot(aes(x = IMC, y = capital)) + 
  geom_point(alpha = .2) + 
  scale_x_log10() + 
  scale_y_log10() + 
  facet_wrap(~ sex) +
  labs(
    x = "",
    y = "sex"
  )

insurance_train %>%
  ggplot(aes(x = IMC, y = capital)) + 
  geom_point(alpha = .2) + 
  scale_x_log10() + 
  scale_y_log10() + 
  facet_wrap(~ smoker) +
  labs(
    x = "",
    y = "smoker"
  ) 

# very important change
insurance_train %>%
  ggplot(aes(x = IMC, y = capital)) + 
  geom_point(alpha = .2) + 
  scale_x_log10() + 
  scale_y_log10() + 
  facet_wrap(~ good_health) +
  labs(
    x = "",
    y = "good health"
  )
```

Now, in order to select the variables, we are going to fit first a glm with all the variables that could affect the model and their interactions. Then, we will use an stepwise selection to get the best set of predictors.

```{r}
max_model <- glm(mortality ~ (period + cover + sex + smoker + good_health + actuarial_age + duration + capital + IMC)^2 
                 - actuarial_age:duration - actuarial_age:capital - actuarial_age:IMC - duration:capital - duration:IMC - capital:IMC, 
                 data = insurance_train,
                 family = "binomial")

min_model <- glm(mortality ~ 1,
                 data = insurance_train,
                 family = "binomial")

step_model <- step(max_model,
                   direction="backward",
                   scope=list(lower=min_model,
                              upper=max_model), trace = 0)

```



## Preprocessing steps:

After seeing some description of the variables, the preprocessing steps we are going to follow are:

1. A method of resampling for the unbalanced class (e.g. `step_downsample(mortality)`).
2. Convert to dummy variables all categorical since it is usually useful for the majority of models.
3. For the numeric variables `capital` and `IMC`, we will apply the log10 for making them symmetric.
4. For the 1st categorical variable of the capital, we should encode it, since we have too many categories.

Also, for some models, it is mandatory to scale and center the variables, but for the moment, we are not going to do it.


# A simple model

Recipe:
```{r}
# Formula
rec <- 
  recipe(mortality ~ period + cover + sex + smoker + good_health + actuarial_age + duration + capital + IMC, data = insurance_train)

# Preprocessing steps
rec <- rec %>%
  themis::step_downsample(mortality) %>%
  step_dummy(all_nominal(), -all_outcomes()) %>%
  step_log(capital, IMC, base = 10)

# Data preprocessed
insurance_train_prep <- rec %>%
  prep() %>%
  bake(new_data = NULL)

summary(insurance_train_prep$mortality)
```

Model and workflow:
```{r}
glm_model <- logistic_reg() %>%
  set_engine("glm")

glm_wflow <- workflow() %>%
  add_model(glm_model) %>%
  add_recipe(rec)
```

Fitting the model and description
```{r}
glm_fit <- fit(glm_wflow, insurance_train)
tidy(glm_fit) %>% 
  dwplot(dot_args = list(size = 2, color = "black"),
         whisker_args = list(color = "black"),
         vline = geom_vline(xintercept = 0, colour = "grey50", linetype = 2))
```

Prediction in the training set and roc curve:
```{r}
pred <- predict(glm_fit, insurance_train)
prob <- predict(glm_fit, insurance_train, type = "prob")

pred <- pred %>%
  mutate(mortality = insurance_train$mortality)

pred %>%
  conf_mat(truth = mortality,
           estimate = .pred_class)

pred %>%
  conf_mat(truth = mortality,
           estimate = .pred_class) %>%
  summary()

prob <- prob %>%
  mutate(mortality = insurance_train$mortality)
pred_curve <- prob %>%
  roc_curve(mortality, .pred_yes, event_level = "second")
prob %>%
  roc_auc(mortality, .pred_no)
autoplot(pred_curve)
```