---
title: '**TFM: exploratory Data Analysis (EDA)**'
author: '*Roberto Jes√∫s Alcaraz Molina*'
date: "14/04/2021"
output:
  pinsurance_document:
    toc: T
    fig_caption: yes
header-includes: 
- \usepackage{float}
- \usepackage{amsbsy}
- \usepackage{amsmath}
- \usepackage{graphicx}
- \usepackage{subfig}
- \usepackage{booktabs}
---

```{r include=FALSE}
knitr::opts_chunk$set(warning = FALSE, 
                      echo = F, 
                      message = FALSE,
                      fig.pos="H", 
                      fig.align="center",
                      fig.width=15,
                      cache=FALSE, error = TRUE)
```

```{r, echo = F}
# install.packages("pacman")
pacman::p_load(tidyverse, tidymodels, workflows, tune, patchwork)
theme_set(theme_bw())

# Models packages
pacman::p_load(ranger)
```

```{r}
insurance <- readRDS("insurance.RDS")
insurance_accident <- readRDS("insurance_accident.RDS")
insurance_caidas <- readRDS("insurance_caidas.RDS")
```


# Description of the variables

Indicative variables:
- `ID`
- `key`

Categorical variables (10 + 1):
- `accident` (target)
- `period`
- `cover`
- `sex`
- `smoker`
- `good_health`

- `capital_factor_1`
- `capital_factor_2`
- `capital_factor_3`
- `IMC_factor_1`
- `IMC_factor_2`

```{r}
# accident
table(insurance$accident)/nrow(insurance)
```

```{r}
# COVER
table(insurance$cover)/nrow(insurance)

insurance %>%
  ggplot(aes(x = cover)) +
  geom_bar() 

tab <- table(insurance$cover, insurance$accident)
cbind(tab, tab[, 2] / (tab[, 1] + tab[, 2]))
```

```{r}
# sex
table(insurance$sex)/nrow(insurance)

insurance %>%
  ggplot(aes(x = sex)) +
  geom_bar() 

tab <- table(insurance$sex, insurance$accident)
cbind(tab, tab[, 2] / (tab[, 1] + tab[, 2]))
```

```{r}
# smoker
table(insurance$smoker)/nrow(insurance)

insurance %>%
  ggplot(aes(x = smoker)) +
  geom_bar() 

tab <- table(insurance$smoker, insurance$accident)
cbind(tab, tab[, 2] / (tab[, 1] + tab[, 2]))
```

```{r}
# good_health  
table(insurance$good_health)/nrow(insurance)
insurance %>%
  ggplot(aes(x = good_health)) +
  geom_bar() 
tab <- table(insurance$good_health, insurance$accident)
cbind(tab, tab[, 2] / (tab[, 1] + tab[, 2]))
```

```{r}
# capital_DESC
table(insurance$capital_factor_1)/nrow(insurance)
insurance %>%
  ggplot(aes(x = capital_factor_1)) +
  geom_bar() 

tab <- table(insurance$capital_factor_1, insurance$accident)
cbind(tab, tab[, 2] / (tab[, 1] + tab[, 2]))

table(insurance$capital_factor_2)/nrow(insurance)
insurance %>%
  ggplot(aes(x = capital_factor_2)) +
  geom_bar() 
tab <- table(insurance$capital_factor_2, insurance$accident)
cbind(tab, tab[, 2] / (tab[, 1] + tab[, 2]))

table(insurance$capital_factor_3)/nrow(insurance)
insurance %>%
  ggplot(aes(x = capital_factor_3)) +
  geom_bar() 
tab <- table(insurance$capital_factor_3, insurance$accident)
cbind(tab, tab[, 2] / (tab[, 1] + tab[, 2]))
```

```{r}
# IMC_DESC
table(insurance$IMC_factor_1)/nrow(insurance)
insurance %>%
  ggplot(aes(x = IMC_factor_1)) +
  geom_bar() 

tab <- table(insurance$IMC_factor_1, insurance$accident)
cbind(tab, tab[, 2] / (tab[, 1] + tab[, 2]))

table(insurance$IMC_factor_2)/nrow(insurance)
insurance %>%
  ggplot(aes(x = IMC_factor_2)) +
  geom_bar() 

tab <- table(insurance$IMC_factor_2, insurance$accident)
cbind(tab, tab[, 2] / (tab[, 1] + tab[, 2]))
```


Numerical variables (7):
- `actuarial_age`
- `sus_age`
- `exp`
- `duration`
- `duration_cat`
- `capital`
- `IMC`


```{r}
# actuarial_age
insurance %>%
  ggplot(aes(x = actuarial_age)) +
  geom_histogram(aes(y=..density..), colour="black", fill="white")+
  geom_density(alpha=.2, fill="#FF6666") 

# sus_age
insurance %>%
  ggplot(aes(x = sus_age)) +
  geom_histogram(aes(y=..density..), colour="black", fill="white")+
  geom_density(alpha=.2, fill="#FF6666") 
```

```{r}
# exp
table(ifelse(insurance$exp == 1, "=1", "<1"))/nrow(insurance)
insurance %>%
  ggplot(aes(x = exp)) +
  geom_histogram(aes(y=..density..), colour="black", fill="white")+
  geom_density(alpha=.2, fill="#FF6666") 
```

```{r}
# duration
insurance %>%
  ggplot(aes(x = duration)) +
  geom_histogram(aes(y=..density..), colour="black", fill="white")+
  geom_density(alpha=.2, fill="#FF6666") 

# duration_cat
insurance %>%
  ggplot(aes(x = duration_cat)) +
  geom_histogram(aes(y=..density..), colour="black", fill="white")+
  geom_density(alpha=.2, fill="#FF6666") 
```

```{r}
# capital
summary(insurance$capital)
insurance %>%
  ggplot(aes(x = capital)) +
  geom_histogram(aes(y=..density..), colour="black", fill="white")+
  geom_density(alpha=.2, fill="#FF6666") 

```

```{r}
# IMC
summary(insurance$IMC)

# Persona de 1.80 y 180kg: 55.6 de IMC
insurance %>%
  filter(IMC > 55)

insurance %>%
  ggplot(aes(x = IMC)) +
  geom_histogram(aes(y=..density..), colour="black", fill="white")+
  geom_density(alpha=.2, fill="#FF6666") 
```

```{r}
# CAIDAS
table(insurance_caidas$CAIDA)/nrow(insurance_caidas)
insurance_caidas %>%
  ggplot(aes(x = CAIDA)) +
  geom_bar() 
```



# Modelos

Indicative variables:
- `ID`
- `key`

Categorical variables (10 + 1):
- `accident` (target)
- `period`
- `cover`
- `sex`
- `smoker`
- `good_health`

- `capital_factor_1`
- `capital_factor_2`
- `capital_factor_3`
- `IMC_factor_1`
- `IMC_factor_2`

Numerical variables (7):
- `actuarial_age`
- `sus_age`
- `exp`
- `duration`
- `duration_cat`
- `capital`
- `IMC`



## explanatory model

```{r}
set.seed(123)
insurance_split <- initial_split(data = insurance, prop = 3/4, strata = accident)
insurance_train <- training(insurance_split)
insurance_test <- testing(insurance_split)
```

```{r}
my_formula_1 <- as.formula(accident ~ PERIODO + cover + sex + smoker + good_health + actuarial_age + exp + duration + capital + IMC)
my_formula_2 <- as.formula(accident ~ PERIODO + cover + sex + smoker + good_health + actuarial_age + exp + duration + capital + IMC_factor_1)
my_formula_3 <- as.formula(accident ~ PERIODO + cover + sex + smoker + good_health + actuarial_age + exp + duration + capital + IMC_factor_2)
my_formula_4 <- as.formula(accident ~ PERIODO + cover + sex + smoker + good_health + actuarial_age + exp + duration + IMC + capital_factor_1)
my_formula_5 <- as.formula(accident ~ PERIODO + cover + sex + smoker + good_health + actuarial_age + exp + duration + IMC + capital_factor_2)
my_formula_6 <- as.formula(accident ~ PERIODO + cover + sex + smoker + good_health + actuarial_age + exp + duration + IMC + capital_factor_3)
```


```{r}
glm_model <- logistic_reg() %>% 
  set_engine("glm") %>% 
  set_mode("classification")

glm_fit <- glm_model %>%
  fit(my_formula_1, data = insurance_train)

tidy(glm_fit) %>% 
  dwplot(dot_args = list(size = 2, color = "black"),
         whisker_args = list(color = "black"),
         vline = geom_vline(xintercept = 0, colour = "grey50", linetype = 2))

test_predictions <- predict(glm_fit, new_data = insurance_test)
test_predictions <- test_predictions %>%
  mutate(accident = insurance_test$accident)

test_predictions %>% 
  conf_mat(truth = accident, estimate = .pred_class) %>%
  summary()
```


```{r}
fit <- glm(formula = my_formula, data = insurance_training, family = binomial)
summary(fit)

pred <- predict(fit, newdata = insurance_testing, type = "response")
summary(pred)
```

```{r}
set.seed(123)

insurance_1 <- insurance[, c("PERIODO", "cover", "sex", "smoker", "good_health", "actuarial_age", "accident", "exp", "duration", "capital", "IMC")]

insurance_split_1 <- initial_split(data = insurance_1, prop = 3/4, strata = accident)
insurance_train_1 <- training(insurance_split_1)
insurance_test_1  <- testing(insurance_split_1)
# cv
insurance_train_1_cv <- vfold_cv(insurance_train_1)

sin_recipe <- 
  recipe(accident ~ ., data = insurance_1) %>%
  step_normalize(all_numeric()) %>%
  step_BoxCox(accident)

insurance_train_preprocessed <- sin_recipe %>%
  prep(insurance_train_1) 
```

```{r}
rf_model <- 
  rand_forest() %>%
  set_args(mtry = tune()) %>%
  set_engine("ranger", importance = "impurity") %>%
  set_mode("classification") 

rf_workflow <- workflow() %>%
  add_recipe(sin_recipe) %>%
  add_model(rf_model)

rf_grid <- expand.grid(mtry = c(3, 4, 5))
# extract results
rf_tune_results <- rf_workflow %>%
  tune_grid(resamples = insurance_train_1_cv, #CV object
            grid = rf_grid, # grid of values to try
            metrics = metric_set(accuracy, roc_auc) # metrics we care about
            )

# print results
rf_tune_results %>%
  collect_metrics()
```


