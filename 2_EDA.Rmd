---
title: '**TFM: Exploratory Data Analysis (EDA)**'
author: '*Roberto Jes√∫s Alcaraz Molina*'
date: "14/04/2021"
output:
  pinsurance_document:
    toc: T
    fig_caption: yes
header-includes: 
- \usepackage{float}
- \usepackage{amsbsy}
- \usepackage{amsmath}
- \usepackage{graphicx}
- \usepackage{subfig}
- \usepackage{booktabs}
---

```{r include=FALSE}
knitr::opts_chunk$set(warning = FALSE, 
                      echo = F, 
                      message = FALSE,
                      fig.pos="H", 
                      fig.align="center",
                      fig.width=15,
                      cache=FALSE, error = TRUE)
```

```{r, echo = F}
# install.packages("pacman")
pacman::p_load(tidyverse, tidymodels, workflows, tune, patchwork, FactoMineR)
theme_set(theme_bw())

# Models packages
pacman::p_load(ranger)
```

```{r}
insurance <- readRDS("insurance.RDS")
insurance_accident <- readRDS("insurance_accident.RDS")
insurance_caidas <- readRDS("insurance_caidas.RDS")
```


# Description and visualization of the variables

Our variables are:

- **Indicative variables**:
  - `ID`
  - `key`

- **Categorical variables (10 + 1)**:
  - `accident` (target)
  - `period`
  - `cover`
  - `sex`
  - `smoker`
  - `good_health`
  
  - `capital_factor_1`
  - `capital_factor_2`
  - `capital_factor_3`
  
  - `IMC_factor_1`
  - `IMC_factor_2`

-**Numerical variables (7)**:
  - `actuarial_age`
  - `sus_age`
  - `exp`
  - `duration`
  - `duration_cat`
  - `capital`
  - `IMC`

## Target variable: `accident`

```{r}
# accident
table(insurance$accident)/nrow(insurance)
```

We are going to split the data in 70% for training and 30% for testing
```{r}
set.seed(123)

insurance_split <- initial_split(insurance, 
                                 prop = 0.7, 
                                 strata = accident)
class(insurance_split)
insurance_train <- training(insurance_split)
insurance_test <- testing(insurance_split)
```

Now, doing a simple model we can see that it is not useful:
```{r}
rec <- 
  recipe(accident ~ period + cover + sex + smoker + good_health + actuarial_age + exp + duration + capital + IMC, data = insurance_train)

glm_model <- logistic_reg() %>%
  set_engine("glm")

glm_wflow <- workflow() %>%
  add_recipe(rec) %>%
  add_model(glm_model)

glm_fit <- fit(glm_wflow, insurance_train)
pred <- predict(glm_fit, insurance_test)

pred <- pred %>%
  mutate(accident = insurance_test$accident)
pred %>%
  conf_mat(truth = accident,
           estimate = .pred_class)

#           Truth
# Prediction     no    yes
#        no  113279     66
#        yes      0      0
```


## Categorical variables (10 + 1)

- `period`
- `cover`
- `sex`
- `smoker`
- `good_health`

- `capital_factor_1`
- `capital_factor_2`
- `capital_factor_3`
- `IMC_factor_1`
- `IMC_factor_2`


```{r}
# Period
table(insurance_train$period)/nrow(insurance_train)

insurance_train %>%
  ggplot(aes(x = period)) +
  geom_bar() 

tab <- table(insurance_train$period, insurance_train$accident)
cbind(tab, tab[, 2] / (tab[, 1] + tab[, 2]))
```


```{r}
# COVER
table(insurance_train$cover)/nrow(insurance_train)

insurance_train %>%
  ggplot(aes(x = cover)) +
  geom_bar() 

tab <- table(insurance_train$cover, insurance_train$accident)
cbind(tab, tab[, 2] / (tab[, 1] + tab[, 2]))

# as we increase the number of coverages, the proportion increases
```

```{r}
# sex
table(insurance_train$sex)/nrow(insurance_train)

insurance_train %>%
  ggplot(aes(x = sex)) +
  geom_bar() 

tab <- table(insurance_train$sex, insurance_train$accident)
cbind(tab, tab[, 2] / (tab[, 1] + tab[, 2]))

# almost double in men
```

```{r}
# smoker
table(insurance_train$smoker)/nrow(insurance_train)

insurance_train %>%
  ggplot(aes(x = smoker)) +
  geom_bar() 

tab <- table(insurance_train$smoker, insurance_train$accident)
cbind(tab, tab[, 2] / (tab[, 1] + tab[, 2]))

# almost double in smokers
```

```{r}
# good_health  
table(insurance_train$good_health)/nrow(insurance_train)
insurance_train %>%
  ggplot(aes(x = good_health)) +
  geom_bar() 
tab <- table(insurance_train$good_health, insurance_train$accident)
cbind(tab, tab[, 2] / (tab[, 1] + tab[, 2]))

# slightly higher for the people without good health
```

```{r}
# capital_DESC
table(insurance_train$capital_factor_1)/nrow(insurance_train)
insurance_train %>%
  ggplot(aes(x = capital_factor_1)) +
  geom_bar() 

tab <- table(insurance_train$capital_factor_1, insurance_train$accident)
cbind(tab, tab[, 2] / (tab[, 1] + tab[, 2]))
# since we have many cateogories, we should think about encoding it.


table(insurance_train$capital_factor_2)/nrow(insurance_train)
insurance_train %>%
  ggplot(aes(x = capital_factor_2)) +
  geom_bar() 
tab <- table(insurance_train$capital_factor_2, insurance_train$accident)
cbind(tab, tab[, 2] / (tab[, 1] + tab[, 2]))
# we should convert it to dummy. Lower proportion of accidents in the last group

table(insurance_train$capital_factor_3)/nrow(insurance_train)
insurance_train %>%
  ggplot(aes(x = capital_factor_3)) +
  geom_bar() 
tab <- table(insurance_train$capital_factor_3, insurance_train$accident)
cbind(tab, tab[, 2] / (tab[, 1] + tab[, 2]))
# convert it to dummy
```

```{r}
# IMC_DESC
table(insurance_train$IMC_factor_1)/nrow(insurance_train)
insurance_train %>%
  ggplot(aes(x = IMC_factor_1)) +
  geom_bar() 

tab <- table(insurance_train$IMC_factor_1, insurance_train$accident)
cbind(tab, tab[, 2] / (tab[, 1] + tab[, 2]))

table(insurance_train$IMC_factor_2)/nrow(insurance_train)
insurance_train %>%
  ggplot(aes(x = IMC_factor_2)) +
  geom_bar() 

tab <- table(insurance_train$IMC_factor_2, insurance_train$accident)
cbind(tab, tab[, 2] / (tab[, 1] + tab[, 2]))

# the two of them are very similar. Double in people with risk/overweight
```

## Numerical variables (7)

- `actuarial_age`
- `sus_age`
- `exp`
- `duration`
- `duration_cat`
- `capital`
- `IMC`


```{r}
# actuarial_age
insurance_train %>%
  ggplot(aes(x = actuarial_age)) +
  geom_histogram(aes(y=..density..), colour="black", fill="white")+
  geom_density(alpha=.2, fill="#FF6666") 
# seems good

# sus_age
insurance_train %>%
  ggplot(aes(x = sus_age)) +
  geom_histogram(aes(y=..density..), colour="black", fill="white")+
  geom_density(alpha=.2, fill="#FF6666") 
```

```{r}
# exp
table(ifelse(insurance_train$exp == 1, "=1", "<1"))/nrow(insurance_train)
insurance_train %>%
  ggplot(aes(x = exp)) +
  geom_histogram(aes(y=..density..), colour="black", fill="white")+
  geom_density(alpha=.2, fill="#FF6666")
```

```{r}
# duration

insurance_train %>%
  ggplot(aes(x = duration)) +
  geom_histogram(aes(y=..density..), colour="black", fill="white")+
  geom_density(alpha=.2, fill="#FF6666") 

# duration_cat
insurance_train %>%
  ggplot(aes(x = duration_cat)) +
  geom_histogram(aes(y=..density..), colour="black", fill="white")+
  geom_density(alpha=.2, fill="#FF6666") 
```

```{r}
# capital
summary(insurance_train$capital)
insurance_train %>%
  ggplot(aes(x = capital)) +
  geom_histogram(aes(y=..density..), colour="black", fill="white")+
  geom_density(alpha=.2, fill="#FF6666") 

insurance_train %>%
  ggplot(aes(x = capital)) +
  geom_histogram(aes(y=..density..), colour="black", fill="white")+
  geom_density(alpha=.2, fill="#FF6666") +
  scale_x_log10()
# here we have some outliers. We should take it into account.
```

```{r}
# IMC
summary(insurance_train$IMC)

insurance_train %>%
  ggplot(aes(x = IMC)) +
  geom_histogram(aes(y=..density..), colour="black", fill="white")+
  geom_density(alpha=.2, fill="#FF6666") 

insurance_train %>%
  ggplot(aes(x = IMC)) +
  geom_histogram(aes(y=..density..), colour="black", fill="white")+
  geom_density(alpha=.2, fill="#FF6666") +
  scale_x_log10()

# Some outliers too
```

```{r}
names(insurance_train)

(a <- cor(insurance_train[, c(8, 10, 12, 14, 15)]))
corrplot::corrplot(a)

insurance_train %>%
  ggplot(aes(x = capital, y = IMC)) +
  geom_point()
# we have no linear correlation between the numerical variables
```

## Preprocessing steps:

After seeing some description of the variables, the preprocessing steps we are going to follow are:

1. A method of resampling for the unbalanced class (e.g. `step_downsample(accident)`).
2. Convert to dummy variables all categorical since it is usually useful for the majority of models.
3. For the numeric variables `capital` and `IMC`, we will apply the log10 for making them symmetric.
4. For the 1st categorical variable of the capital, we should encode it, since we have too many categories.

Also, for some models, it is mandatory to scale and center the variables, but for the moment, we are not going to do it.


# A simple model

Recipe:
```{r}
# Formula
rec <- 
  recipe(accident ~ period + cover + sex + smoker + good_health + actuarial_age + exp + duration + capital + IMC, data = insurance_train)

# Preprocessing steps
rec <- rec %>%
  step_downsample(accident) %>%
  step_dummy(all_nominal(), -all_outcomes()) %>%
  step_log(capital, IMC, base = 10)

# Data preprocessed
insurance_train_prep <- rec %>%
  prep() %>%
  bake(new_data = NULL)
```

Model and workflow:
```{r}
glm_model <- logistic_reg() %>%
  set_engine("glm")

glm_wflow <- workflow() %>%
  add_model(glm_model) %>%
  add_recipe(rec)
```

Fitting the model and description
```{r}
glm_fit <- fit(glm_wflow, insurance_train)
tidy(glm_fit) %>% 
  dwplot(dot_args = list(size = 2, color = "black"),
         whisker_args = list(color = "black"),
         vline = geom_vline(xintercept = 0, colour = "grey50", linetype = 2))
```

Prediction in the training set and roc curve:
```{r}
pred <- predict(glm_fit, insurance_train)
prob <- predict(glm_fit, insurance_train, type = "prob")

pred <- pred %>%
  mutate(accident = insurance_train$accident)

pred %>%
  conf_mat(truth = accident,
           estimate = .pred_class)

pred %>%
  conf_mat(truth = accident,
           estimate = .pred_class) %>%
  summary()

prob <- prob %>%
  mutate(accident = insurance_train$accident)
pred_curve <- prob %>%
  roc_curve(accident, .pred_yes, event_level = "second")
prob %>%
  roc_auc(accident, .pred_no)
autoplot(pred_curve)
```